# üöÄ AWS Deployment Quick Reference

## üìã T√≥m t·∫Øt c√°c b∆∞·ªõc deploy (checklist nhanh)

### Phase 1: Chu·∫©n b·ªã tr√™n m√°y Windows (30 ph√∫t)

```powershell
# 1. Backup database v√† uploads
cd D:\DACN_Web_quanly_hoatdongrenluyen-master
.\scripts\prepare-deployment.ps1

# 2. Ki·ªÉm tra deployment-package/
ls .\deployment-package\
# N√™n c√≥: db_production.dump, uploads_backup.zip, *.env.template, DEPLOYMENT_CHECKLIST.txt
```

### Phase 2: T·∫°o v√† c·∫•u h√¨nh EC2 (20 ph√∫t)

1. **AWS Console** ‚Üí EC2 ‚Üí Launch Instance
2. C·∫•u h√¨nh:
   - **Name:** `dacn-web-server`
   - **OS:** Ubuntu 22.04 LTS
   - **Type:** `t3.medium` (2 vCPU, 4GB RAM)
   - **Key:** Create `dacn-web-key.pem` ‚Üí Download
   - **Security Group:** Ports 22, 80, 443, 3000, 3001
   - **Storage:** 30GB gp3
3. Launch v√† ƒë·ª£i instance kh·ªüi ƒë·ªông
4. Copy **Public IP:** `54.169.xxx.xxx`

### Phase 3: K·∫øt n·ªëi v√† c√†i ƒë·∫∑t m√¥i tr∆∞·ªùng (20 ph√∫t)

```bash
# 1. Convert .pem ‚Üí .ppk b·∫±ng PuTTYgen
# 2. K·∫øt n·ªëi SSH b·∫±ng PuTTY (ubuntu@54.169.xxx.xxx)

# 3. Upload v√† ch·∫°y script setup (tr√™n EC2)
# D√πng WinSCP upload file: scripts/aws-setup.sh ‚Üí /home/ubuntu/
chmod +x ~/aws-setup.sh
./aws-setup.sh

# 4. Logout v√† login l·∫°i
exit
# (SSH l·∫°i ƒë·ªÉ apply docker group)
```

### Phase 4: Deploy ·ª©ng d·ª•ng (30 ph√∫t)

```bash
# 1. Clone repository
cd ~/dacn-web
git clone https://github.com/ThLin57/DACN_Web_quanly_hoatdongrenluyen.git app
cd app

# 2. T·∫°o .env files
# Backend
nano ~/dacn-web/app/backend/.env
```
```bash
NODE_ENV=production
PORT=3001
DATABASE_URL=postgresql://admin:YOUR_STRONG_PASSWORD@db:5432/Web_QuanLyDiemRenLuyen?schema=public
JWT_SECRET=$(openssl rand -base64 48)  # Ch·∫°y l·ªánh n√†y ƒë·ªÉ t·∫°o secret
JWT_EXPIRES_IN=7d
CORS_ORIGIN=https://yourdomain.com
LOG_LEVEL=info
```

```bash
# Frontend
nano ~/dacn-web/app/frontend/.env
```
```bash
REACT_APP_API_URL=https://yourdomain.com/api
```

```bash
# 3. S·ª≠a docker-compose.yml
nano ~/dacn-web/app/docker-compose.yml
# ƒê·ªïi:
# - POSTGRES_PASSWORD ‚Üí password m·∫°nh
# - restart: unless-stopped ‚Üí restart: always
# - Comment port 5432 (kh√¥ng expose ra ngo√†i)

# 4. Build v√† ch·∫°y database
docker compose --profile prod build
docker compose up -d db
sleep 15

# 5. Restore database (upload db_production.dump tr∆∞·ªõc b·∫±ng WinSCP)
docker cp ~/dacn-web/backups/db_production.dump dacn_db_prod:/tmp/db.dump
docker compose exec db bash -c "pg_restore -U admin -d Web_QuanLyDiemRenLuyen -c -v /tmp/db.dump"

# 6. Restore uploads (upload uploads_backup.zip tr∆∞·ªõc)
cd ~/dacn-web/backups
unzip uploads_backup.zip
mkdir -p ~/dacn-web/app/backend/uploads
cp -r uploads/* ~/dacn-web/app/backend/uploads/

# 7. Ch·∫°y application
cd ~/dacn-web/app
docker compose --profile prod up -d app

# 8. Ki·ªÉm tra logs
docker compose logs -f app
# Ch·ªù th·∫•y: "Server started successfully on port 3001"

# 9. Test API
curl http://localhost:3001/api/health
# N√™n th·∫•y: {"status":"ok",...}
```

### Phase 5: C·∫•u h√¨nh Nginx v√† SSL (30 ph√∫t)

```bash
# 1. C·∫•u h√¨nh Nginx
sudo nano /etc/nginx/sites-available/dacn-web
```
```nginx
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    
    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

```bash
# 2. Enable config
sudo ln -s /etc/nginx/sites-available/dacn-web /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default
sudo nginx -t
sudo systemctl restart nginx

# 3. Tr·ªè domain A record v·ªÅ EC2 IP
# (L√†m tr√™n domain provider: GoDaddy, Namecheap, etc.)

# 4. C√†i SSL certificate
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com
# Ch·ªçn option 2 (Redirect HTTP to HTTPS)

# 5. Test
curl https://yourdomain.com/api/health
```

---

## üîß L·ªánh th∆∞·ªùng d√πng

### Docker containers

```bash
# Xem status t·∫•t c·∫£ containers
docker compose ps

# Xem logs
docker compose logs -f              # T·∫•t c·∫£
docker compose logs -f app          # Backend
docker compose logs -f db           # Database

# Restart containers
docker compose restart app          # Restart backend
docker compose restart db           # Restart database

# Stop containers
docker compose --profile prod down  # Stop t·∫•t c·∫£

# Start containers
docker compose --profile prod up -d # Start l·∫°i
```

### Database operations

```bash
# Backup database
~/backup-database.sh

# Manual backup
docker compose exec -T db pg_dump -U admin -d Web_QuanLyDiemRenLuyen -Fc > ~/backup_$(date +%Y%m%d).dump

# Restore database
docker cp ~/backup.dump dacn_db_prod:/tmp/restore.dump
docker compose exec db bash -c "pg_restore -U admin -d Web_QuanLyDiemRenLuyen -c -v /tmp/restore.dump"

# Connect to database
docker compose exec db psql -U admin -d Web_QuanLyDiemRenLuyen

# List tables
docker compose exec db psql -U admin -d Web_QuanLyDiemRenLuyen -c "\dt"

# Count records
docker compose exec db psql -U admin -d Web_QuanLyDiemRenLuyen -c "SELECT 'SinhVien', COUNT(*) FROM \"SinhVien\" UNION ALL SELECT 'HoatDong', COUNT(*) FROM \"HoatDong\";"
```

### Nginx operations

```bash
# Test config
sudo nginx -t

# Reload config (no downtime)
sudo systemctl reload nginx

# Restart Nginx
sudo systemctl restart nginx

# View access logs
sudo tail -f /var/log/nginx/access.log

# View error logs
sudo tail -f /var/log/nginx/error.log

# Check status
sudo systemctl status nginx
```

### SSL Certificate

```bash
# Renew certificate manually
sudo certbot renew

# Force renew
sudo certbot renew --force-renewal

# Check auto-renewal timer
sudo systemctl status certbot.timer

# Test renewal (dry run)
sudo certbot renew --dry-run
```

### System monitoring

```bash
# Health check
~/check-health.sh

# CPU/RAM usage (interactive)
htop

# Disk usage
df -h

# Docker stats (realtime)
docker stats

# View all running processes
ps aux | grep node
ps aux | grep postgres

# Check open ports
sudo netstat -tlnp | grep LISTEN

# Memory info
free -h

# System logs
sudo journalctl -u docker -n 50
```

### Update application

```bash
# Pull latest code
cd ~/dacn-web/app
git pull origin main

# Rebuild and restart
docker compose --profile prod build app
docker compose --profile prod up -d app

# Run migrations (if any)
docker compose exec app npx prisma migrate deploy

# View logs
docker compose logs -f app
```

---

## üêõ Troubleshooting nhanh

### L·ªói: Website kh√¥ng truy c·∫≠p ƒë∆∞·ª£c

```bash
# 1. Ki·ªÉm tra containers c√≥ ch·∫°y kh√¥ng
docker compose ps
# N·∫øu d·ª´ng ‚Üí docker compose --profile prod up -d

# 2. Ki·ªÉm tra Nginx
sudo systemctl status nginx
# N·∫øu d·ª´ng ‚Üí sudo systemctl start nginx

# 3. Ki·ªÉm tra logs
docker compose logs app | tail -50
sudo tail -50 /var/log/nginx/error.log

# 4. Test API direct
curl http://localhost:3001/api/health
```

### L·ªói: Database connection failed

```bash
# 1. Ki·ªÉm tra DB container
docker compose ps db
docker compose logs db | tail -30

# 2. Test connection t·ª´ app
docker compose exec app node -e "const {Client}=require('pg');(async()=>{try{const c=new Client({connectionString:process.env.DATABASE_URL});await c.connect();console.log('‚úÖ Connected');await c.end();}catch(e){console.error('‚ùå',e.message)}})()"

# 3. Ki·ªÉm tra DATABASE_URL
docker compose exec app printenv DATABASE_URL

# 4. Restart DB
docker compose restart db
sleep 10
docker compose restart app
```

### L·ªói: Out of Memory

```bash
# 1. Ki·ªÉm tra memory
free -h
docker stats --no-stream

# 2. Th√™m swap space
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

# 3. Restart containers
docker compose restart
```

### L·ªói: SSL certificate error

```bash
# 1. Check certificate expiry
sudo certbot certificates

# 2. Renew certificate
sudo certbot renew
sudo systemctl restart nginx

# 3. If renewal fails, re-issue
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com --force-renewal
```

### L·ªói: Port already in use

```bash
# 1. T√¨m process ƒëang d√πng port
sudo lsof -i :3001
sudo lsof -i :80

# 2. Kill process (n·∫øu kh√¥ng ph·∫£i app c·ªßa b·∫°n)
sudo kill -9 <PID>

# 3. Restart containers
docker compose --profile prod down
docker compose --profile prod up -d
```

---

## üìä Security Checklist

### ‚úÖ Sau khi deploy xong, ki·ªÉm tra:

```bash
# 1. Password ƒë√£ ƒë·ªïi ch∆∞a?
# - PostgreSQL password trong docker-compose.yml
# - JWT_SECRET trong backend/.env (d√πng openssl rand -base64 48)

# 2. Ports kh√¥ng c·∫ßn thi·∫øt ƒë√£ ƒë√≥ng?
sudo ufw status
# Ch·ªâ c·∫ßn: 22 (SSH), 80 (HTTP), 443 (HTTPS)
# KH√îNG expose: 3000, 3001, 5432 ra internet

# 3. SSH key c√≥ an to√†n kh√¥ng?
# - File .ppk tr√™n m√°y Windows gi·ªØ c·∫©n th·∫≠n
# - Kh√¥ng share cho ng∆∞·ªùi kh√°c

# 4. Backup c√≥ t·ª± ƒë·ªông kh√¥ng?
crontab -l
# N√™n th·∫•y: 0 2 * * * ... backup-database.sh

# 5. SSL certificate c√≥ t·ª± ƒë·ªông renew kh√¥ng?
sudo systemctl status certbot.timer
# N√™n th·∫•y: active (running)

# 6. Log files c√≥ rotate kh√¥ng?
docker inspect dacn_app_prod | grep -A 5 LogConfig
# N√™n th·∫•y: "max-size": "20m", "max-file": "10"
```

---

## üéØ Performance Optimization

### N·∫øu website ch·∫≠m:

```bash
# 1. Enable Nginx caching
sudo nano /etc/nginx/sites-available/dacn-web
```
```nginx
# Th√™m v√†o block server:
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m;

# Trong location /:
proxy_cache my_cache;
proxy_cache_valid 200 60m;
proxy_cache_valid 404 1m;
add_header X-Cache-Status $upstream_cache_status;
```

```bash
# 2. Enable gzip compression (th√™m v√†o server block)
gzip on;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
gzip_min_length 1000;

# 3. Restart Nginx
sudo systemctl restart nginx
```

### Database optimization:

```bash
# Vacuum database
docker compose exec db psql -U admin -d Web_QuanLyDiemRenLuyen -c "VACUUM ANALYZE;"

# Check slow queries (n·∫øu c√≥)
docker compose logs app | grep -i "slow query"
```

---

## üìû Li√™n h·ªá v√† Support

### Log files quan tr·ªçng:

```bash
# Application logs
~/dacn-web/app/backend/logs/combined.log
~/dacn-web/app/backend/logs/error.log

# Docker logs
docker compose logs

# Nginx logs
/var/log/nginx/access.log
/var/log/nginx/error.log

# System logs
sudo journalctl -xe
```

### Useful commands t·ªïng h·ª£p:

```bash
# Full system status report
cat << EOF
=== SYSTEM STATUS ===
Uptime: $(uptime)
Disk: $(df -h / | tail -1 | awk '{print $3"/"$2" ("$5")"}')
Memory: $(free -h | grep Mem | awk '{print $3"/"$2}')
Containers: $(docker compose ps --format "{{.Name}}: {{.Status}}" | paste -sd ", ")
Nginx: $(sudo systemctl is-active nginx)
Last backup: $(ls -t ~/dacn-web/backups/db_backup_*.dump 2>/dev/null | head -1)
SSL expiry: $(sudo openssl x509 -enddate -noout -in /etc/letsencrypt/live/*/cert.pem 2>/dev/null | cut -d= -f2 || echo "No SSL")
EOF
```

---

## üí° Tips and Tricks

### T·ª± ƒë·ªông kh·ªüi ƒë·ªông l·∫°i app n·∫øu crash:

```bash
# ƒê√£ c√≥ trong docker-compose.yml:
restart: always

# Ki·ªÉm tra:
docker inspect dacn_app_prod | grep -i restart
# N√™n th·∫•y: "RestartPolicy": {"Name": "always"}
```

### TƒÉng file upload limit:

```bash
# S·ª≠a Nginx config
sudo nano /etc/nginx/nginx.conf
# Th√™m v√†o http block:
client_max_body_size 50M;

# Restart
sudo systemctl restart nginx
```

### Rate limiting (ch·ªëng DDoS):

```bash
sudo nano /etc/nginx/sites-available/dacn-web
# Th√™m tr∆∞·ªõc server block:
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# Trong location /api:
limit_req zone=api_limit burst=20 nodelay;
```

---

**L∆∞u file n√†y ƒë·ªÉ tham kh·∫£o nhanh khi c·∫ßn! üöÄ**
